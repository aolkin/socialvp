!function(e){function O(e,t){return function(n){return j(e.call(this,n),t)}}function M(e){return function(t){return this.lang().ordinal(e.call(this,t))}}function _(){}function D(e){H(this,e)}function P(e){var t=this._data={},n=e.years||e.year||e.y||0,r=e.months||e.month||e.M||0,i=e.weeks||e.week||e.w||0,s=e.days||e.day||e.d||0,o=e.hours||e.hour||e.h||0,u=e.minutes||e.minute||e.m||0,a=e.seconds||e.second||e.s||0,f=e.milliseconds||e.millisecond||e.ms||0;this._milliseconds=f+1e3*a+6e4*u+36e5*o,this._days=s+7*i,this._months=r+12*n,t.milliseconds=f%1e3,a+=B(f/1e3),t.seconds=a%60,u+=B(a/60),t.minutes=u%60,o+=B(u/60),t.hours=o%24,s+=B(o/24),s+=7*i,t.days=s%30,r+=B(s/30),t.months=r%12,n+=B(r/12),t.years=n}function H(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function B(e){return 0>e?Math.ceil(e):Math.floor(e)}function j(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}function F(e,t,n){var r=t._milliseconds,i=t._days,s=t._months,o;r&&e._d.setTime(+e+r*n),i&&e.date(e.date()+i*n),s&&(o=e.date(),e.date(1).month(e.month()+s*n).date(Math.min(o,e.daysInMonth())))}function I(e){return"[object Array]"===Object.prototype.toString.call(e)}function q(e,t){var n=Math.min(e.length,t.length),r=Math.abs(e.length-t.length),i=0,s;for(s=0;n>s;s++)~~e[s]!==~~t[s]&&i++;return i+r}function R(e,t){return t.abbr=e,s[e]||(s[e]=new _),s[e].set(t),s[e]}function U(e){return e?(!s[e]&&o&&require("./lang/"+e),s[e]):t.fn._lang}function z(e){return e.match(/\[.*\]/)?e.replace(/^\[|\]$/g,""):e.replace(/\\/g,"")}function W(e){var t=e.match(a),n,r;for(n=0,r=t.length;r>n;n++)t[n]=A[t[n]]?A[t[n]]:z(t[n]);return function(i){var s="";for(n=0;r>n;n++)s+="function"==typeof t[n].call?t[n].call(i,e):t[n];return s}}function X(e,t){function r(t){return e.lang().longDateFormat(t)||t}for(var n=5;n--&&f.test(t);)t=t.replace(f,r);return C[t]||(C[t]=W(t)),C[t](e)}function V(e){switch(e){case"DDDD":return p;case"YYYY":return d;case"YYYYY":return v;case"S":case"SS":case"SSS":case"DDD":return h;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":case"a":case"A":return m;case"X":return b;case"Z":case"ZZ":return g;case"T":return y;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return c;default:return new RegExp(e.replace("\\",""))}}function $(e,t,n){var r,i,s=n._a;switch(e){case"M":case"MM":s[1]=null==t?0:~~t-1;break;case"MMM":case"MMMM":r=U(n._l).monthsParse(t),null!=r?s[1]=r:n._isValid=!1;break;case"D":case"DD":case"DDD":case"DDDD":null!=t&&(s[2]=~~t);break;case"YY":s[0]=~~t+(~~t>68?1900:2e3);break;case"YYYY":case"YYYYY":s[0]=~~t;break;case"a":case"A":n._isPm="pm"===(t+"").toLowerCase();break;case"H":case"HH":case"h":case"hh":s[3]=~~t;break;case"m":case"mm":s[4]=~~t;break;case"s":case"ss":s[5]=~~t;break;case"S":case"SS":case"SSS":s[6]=~~(1e3*("0."+t));break;case"X":n._d=new Date(1e3*parseFloat(t));break;case"Z":case"ZZ":n._useUTC=!0,r=(t+"").match(x),r&&r[1]&&(n._tzh=~~r[1]),r&&r[2]&&(n._tzm=~~r[2]),r&&"+"===r[0]&&(n._tzh=-n._tzh,n._tzm=-n._tzm)}null==t&&(n._isValid=!1)}function J(e){var t,n,r=[];if(!e._d){for(t=0;7>t;t++)e._a[t]=r[t]=null==e._a[t]?2===t?1:0:e._a[t];r[3]+=e._tzh||0,r[4]+=e._tzm||0,n=new Date(0),e._useUTC?(n.setUTCFullYear(r[0],r[1],r[2]),n.setUTCHours(r[3],r[4],r[5],r[6])):(n.setFullYear(r[0],r[1],r[2]),n.setHours(r[3],r[4],r[5],r[6])),e._d=n}}function K(e){var t=e._f.match(a),n=e._i,r,i;for(e._a=[],r=0;r<t.length;r++)i=(V(t[r]).exec(n)||[])[0],i&&(n=n.slice(n.indexOf(i)+i.length)),A[t[r]]&&$(t[r],i,e);e._isPm&&e._a[3]<12&&(e._a[3]+=12),e._isPm===!1&&12===e._a[3]&&(e._a[3]=0),J(e)}function Q(e){for(var t,n,r,i=99,s,o,u;e._f.length;){if(t=H({},e),t._f=e._f.pop(),K(t),n=new D(t),n.isValid()){r=n;break}u=q(t._a,n.toArray()),i>u&&(i=u,r=n)}H(e,r)}function G(e){var t,n=e._i;if(w.exec(n)){for(e._f="YYYY-MM-DDT",t=0;4>t;t++)if(S[t][1].exec(n)){e._f+=S[t][0];break}g.exec(n)&&(e._f+=" Z"),K(e)}else e._d=new Date(n)}function Y(t){var n=t._i,r=u.exec(n);n===e?t._d=new Date:r?t._d=new Date(+r[1]):"string"==typeof n?G(t):I(n)?(t._a=n.slice(0),J(t)):t._d=n instanceof Date?new Date(+n):new Date(n)}function Z(e,t,n,r,i){return i.relativeTime(t||1,!!n,e,r)}function et(e,t,n){var i=r(Math.abs(e)/1e3),s=r(i/60),o=r(s/60),u=r(o/24),a=r(u/365),f=45>i&&["s",i]||1===s&&["m"]||45>s&&["mm",s]||1===o&&["h"]||22>o&&["hh",o]||1===u&&["d"]||25>=u&&["dd",u]||45>=u&&["M"]||345>u&&["MM",r(u/30)]||1===a&&["y"]||["yy",a];return f[2]=t,f[3]=e>0,f[4]=n,Z.apply({},f)}function tt(e,n,r){var i=r-n,s=r-e.day();return s>i&&(s-=7),i-7>s&&(s+=7),Math.ceil(t(e).add("d",s).dayOfYear()/7)}function nt(e){var n=e._i,r=e._f;return null===n||""===n?null:("string"==typeof n&&(e._i=n=U().preparse(n)),t.isMoment(n)?(e=H({},n),e._d=new Date(+n._d)):r?I(r)?Q(e):K(e):Y(e),new D(e))}function rt(e,n){t.fn[e]=t.fn[e+"s"]=function(e){var t=this._isUTC?"UTC":"";return null!=e?(this._d["set"+t+n](e),this):this._d["get"+t+n]()}}function it(e){t.duration.fn[e]=function(){return this._data[e]}}function st(e,n){t.duration.fn["as"+e]=function(){return+this/n}}for(var t,n="2.0.0",r=Math.round,i,s={},o="undefined"!=typeof module&&module.exports,u=/^\/?Date\((\-?\d+)/i,a=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,f=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,l=/([0-9a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)/gi,c=/\d\d?/,h=/\d{1,3}/,p=/\d{3}/,d=/\d{1,4}/,v=/[+\-]?\d{1,6}/,m=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,g=/Z|[\+\-]\d\d:?\d\d/i,y=/T/i,b=/[\+\-]?\d+(\.\d{1,3})?/,w=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,E="YYYY-MM-DDTHH:mm:ssZ",S=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],x=/([\+\-]|\d\d)/gi,T="Month|Date|Hours|Minutes|Seconds|Milliseconds".split("|"),N={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},C={},k="DDD w W M D d".split(" "),L="M D H h m s w W".split(" "),A={M:function(){return this.month()+1},MMM:function(e){return this.lang().monthsShort(this,e)},MMMM:function(e){return this.lang().months(this,e)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(e){return this.lang().weekdaysMin(this,e)},ddd:function(e){return this.lang().weekdaysShort(this,e)},dddd:function(e){return this.lang().weekdays(this,e)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return j(this.year()%100,2)},YYYY:function(){return j(this.year(),4)},YYYYY:function(){return j(this.year(),5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return j(~~(this.milliseconds()/10),2)},SSS:function(){return j(this.milliseconds(),3)},Z:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+j(~~(e/60),2)+":"+j(~~e%60,2)},ZZ:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+j(~~(10*e/6),4)},X:function(){return this.unix()}};k.length;)i=k.pop(),A[i+"o"]=M(A[i]);for(;L.length;)i=L.pop(),A[i+i]=O(A[i],2);for(A.DDDD=O(A.DDD,3),_.prototype={set:function(e){var t,n;for(n in e)t=e[n],"function"==typeof t?this[n]=t:this["_"+n]=t},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(e){return this._months[e.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(e){return this._monthsShort[e.month()]},monthsParse:function(e){var n,r,i,s;for(this._monthsParse||(this._monthsParse=[]),n=0;12>n;n++)if(this._monthsParse[n]||(r=t([2e3,n]),i="^"+this.months(r,"")+"|^"+this.monthsShort(r,""),this._monthsParse[n]=new RegExp(i.replace(".",""),"i")),this._monthsParse[n].test(e))return n},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(e){return this._weekdays[e.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(e){return this._weekdaysShort[e.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(e){return this._weekdaysMin[e.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(e){var t=this._longDateFormat[e];return!t&&this._longDateFormat[e.toUpperCase()]&&(t=this._longDateFormat[e.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)}),this._longDateFormat[e]=t),t},meridiem:function(e,t,n){return e>11?n?"pm":"PM":n?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(e,t){var n=this._calendar[e];return"function"==typeof n?n.apply(t):n},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(e,t,n,r){var i=this._relativeTime[n];return"function"==typeof i?i(e,t,n,r):i.replace(/%d/i,e)},pastFuture:function(e,t){var n=this._relativeTime[e>0?"future":"past"];return"function"==typeof n?n(t):n.replace(/%s/i,t)},ordinal:function(e){return this._ordinal.replace("%d",e)},_ordinal:"%d",preparse:function(e){return e},postformat:function(e){return e},week:function(e){return tt(e,this._week.dow,this._week.doy)},_week:{dow:0,doy:6}},t=function(e,t,n){return nt({_i:e,_f:t,_l:n,_isUTC:!1})},t.utc=function(e,t,n){return nt({_useUTC:!0,_isUTC:!0,_l:n,_i:e,_f:t})},t.unix=function(e){return t(1e3*e)},t.duration=function(e,n){var r=t.isDuration(e),i="number"==typeof e,s=r?e._data:i?{}:e,o;return i&&(n?s[n]=e:s.milliseconds=e),o=new P(s),r&&e.hasOwnProperty("_lang")&&(o._lang=e._lang),o},t.version=n,t.defaultFormat=E,t.lang=function(e,n){var r;return e?(n?R(e,n):s[e]||U(e),t.duration.fn._lang=t.fn._lang=U(e),void 0):t.fn._lang._abbr},t.langData=function(e){return e&&e._lang&&e._lang._abbr&&(e=e._lang._abbr),U(e)},t.isMoment=function(e){return e instanceof D},t.isDuration=function(e){return e instanceof P},t.fn=D.prototype={clone:function(){return t(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1e3)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return t.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var e=this;return[e.year(),e.month(),e.date(),e.hours(),e.minutes(),e.seconds(),e.milliseconds()]},isValid:function(){return null==this._isValid&&(this._isValid=this._a?!q(this._a,(this._isUTC?t.utc(this._a):t(this._a)).toArray()):!isNaN(this._d.getTime())),!!this._isValid},utc:function(){return this._isUTC=!0,this},local:function(){return this._isUTC=!1,this},format:function(e){var n=X(this,e||t.defaultFormat);return this.lang().postformat(n)},add:function(e,n){var r;return r="string"==typeof e?t.duration(+n,e):t.duration(e,n),F(this,r,1),this},subtract:function(e,n){var r;return r="string"==typeof e?t.duration(+n,e):t.duration(e,n),F(this,r,-1),this},diff:function(e,n,r){var i=this._isUTC?t(e).utc():t(e).local(),s=6e4*(this.zone()-i.zone()),o,u;return n&&(n=n.replace(/s$/,"")),"year"===n||"month"===n?(o=432e5*(this.daysInMonth()+i.daysInMonth()),u=12*(this.year()-i.year())+(this.month()-i.month()),u+=(this-t(this).startOf("month")-(i-t(i).startOf("month")))/o,"year"===n&&(u/=12)):(o=this-i-s,u="second"===n?o/1e3:"minute"===n?o/6e4:"hour"===n?o/36e5:"day"===n?o/864e5:"week"===n?o/6048e5:o),r?u:B(u)},from:function(e,n){return t.duration(this.diff(e)).lang(this.lang()._abbr).humanize(!n)},fromNow:function(e){return this.from(t(),e)},calendar:function(){var e=this.diff(t().startOf("day"),"days",!0),n=-6>e?"sameElse":-1>e?"lastWeek":0>e?"lastDay":1>e?"sameDay":2>e?"nextDay":7>e?"nextWeek":"sameElse";return this.format(this.lang().calendar(n,this))},isLeapYear:function(){var e=this.year();return 0===e%4&&0!==e%100||0===e%400},isDST:function(){return this.zone()<t([this.year()]).zone()||this.zone()<t([this.year(),5]).zone()},day:function(e){var t=this._isUTC?this._d.getUTCDay():this._d.getDay();return null==e?t:this.add({d:e-t})},startOf:function(e){switch(e=e.replace(/s$/,"")){case"year":this.month(0);case"month":this.date(1);case"week":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===e&&this.day(0),this},endOf:function(e){return this.startOf(e).add(e.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(e,n){return n="undefined"!=typeof n?n:"millisecond",+this.clone().startOf(n)>+t(e).startOf(n)},isBefore:function(e,n){return n="undefined"!=typeof n?n:"millisecond",+this.clone().startOf(n)<+t(e).startOf(n)},isSame:function(e,n){return n="undefined"!=typeof n?n:"millisecond",+this.clone().startOf(n)===+t(e).startOf(n)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},daysInMonth:function(){return t.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(e){var n=r((t(this).startOf("day")-t(this).startOf("year"))/864e5)+1;return null==e?n:this.add("d",e-n)},isoWeek:function(e){var t=tt(this,1,4);return null==e?t:this.add("d",7*(e-t))},week:function(e){var t=this.lang().week(this);return null==e?t:this.add("d",7*(e-t))},lang:function(t){return t===e?this._lang:(this._lang=U(t),this)}},i=0;i<T.length;i++)rt(T[i].toLowerCase().replace(/s$/,""),T[i]);rt("year","FullYear"),t.fn.days=t.fn.day,t.fn.weeks=t.fn.week,t.fn.isoWeeks=t.fn.isoWeek,t.duration.fn=P.prototype={weeks:function(){return B(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+2592e6*this._months},humanize:function(e){var t=+this,n=et(t,!e,this.lang());return e&&(n=this.lang().pastFuture(t,n)),this.lang().postformat(n)},lang:t.fn.lang};for(i in N)N.hasOwnProperty(i)&&(st(i,N[i]),it(i.toLowerCase()));st("Weeks",6048e5),t.lang("en",{ordinal:function(e){var t=e%10,n=1===~~(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th";return e+n}}),o&&(module.exports=t),"undefined"==typeof ender&&(this.moment=t),"function"==typeof define&&define.amd&&define("moment",[],function(){return t})}.call(this),function(d,g){var h=1e3,i=!1,e=d([]),j=function(b,a){var c=b.data("livestampdata");"number"==typeof a&&(a*=1e3),b.removeAttr("data-livestamp").removeData("livestamp"),a=g(a),g.isMoment(a)&&!isNaN(+a)&&(c=d.extend({},{original:b.contents()},c),c.moment=g(a),b.data("livestampdata",c).empty(),e.push(b[0]))},k=function(){i||(f.update(),setTimeout(k,h))},f={update:function(){d("[data-livestamp]").each(function(){var a=d(this);j(a,a.data("livestamp"))});var b=[];e.each(function(){var a=d(this),c=a.data("livestampdata");if(void 0===c)b.push(this);else if(g.isMoment(c.moment)){var e=a.html(),c=c.moment.fromNow();if(e!=c){var f=d.Event("change.livestamp");a.trigger(f,[e,c]),f.isDefaultPrevented()||a.html(c)}}}),e=e.not(b)},pause:function(){i=!0},resume:function(){i=!1,k()},interval:function(b){return void 0===b?h:(h=b,void 0)}},l={add:function(b,a){return"number"==typeof a&&(a*=1e3),a=g(a),g.isMoment(a)&&!isNaN(+a)&&(b.each(function(){j(d(this),a)}),f.update()),b},destroy:function(b){return e=e.not(b),b.each(function(){var a=d(this),c=a.data("livestampdata");return void 0===c?b:(a.html(c.original?c.original:"").removeData("livestampdata"),void 0)}),b},isLivestamp:function(b){return void 0!==b.data("livestampdata")}};d.livestamp=f,d(function(){f.resume()}),d.fn.livestamp=function(b,a){return l[b]||(a=b,b="add"),l[b](this,a)}}(jQuery,moment),WSChat=function(){return{retries:0,closed:!0,log:!1,init:function(url,name,noretry){return this.closed?(this.connected=!1,this.url=url,this.name=name,this.noretry=void 0===noretry?this.noretry:noretry,this.socket=new WebSocket(url),this.socket.wschat=this,this.socket.onopen=function(e){this.wschat.retries=0,this.wschat.closed=!1},this.socket.onmessage=function(e){ws=this.wschat,data=JSON.parse(e.data),ws.log&&console.log(data),"init"==data.type?ws.send({command:"identify",name:ws.name}):"outcome"==data.type?300==data.code?ws.onconnected(data.message):305==data.code?ws.onerror(data.code,data.message):10==data.code?this.close():400==data.code?console.log("WSChat Protocol Error:",data.code,data.message):404==data.code&&ws.onerror(data.code,data.message,ws.lastmessage):"broadcast"==data.type?ws.onbroadcast(data.message,data.from,e):"message"==data.type?ws.onmessage(data.message,data.from,e):"quit"==data.type&&ws.onquit(data.who,e)},this.socket.onerror=function(e){console.log("Websocket Error:",e),this.wschat.onwserror(e)},this.socket.onclose=function(e){ws=this.wschat,ws.closed=!0,ws.onclose(e),ws.noretry||(ws.retries+=1,setTimeout(function(){ws.init(ws.url,ws.name)},Math.pow(2,ws.retries)))},void 0):!1},message:function(message,to){this.send({command:"message",message:message,to:to})},broadcast:function(message){this.send({command:"broadcast",message:message})},send:function(data){if(this.closed)throw new Error("WSChat WebSocket is currently closed!");this.lastmessage=data,message=JSON.stringify(data),this.socket.send(message)},close:function(){this.socket.close()},onmessage:function(){},onbroadcast:function(){},onerror:function(){},onwserror:function(){},onquit:function(){},onclose:function(){},onconnected:function(){}}},plugins=[],plugins.loaded=!1,plugins.handlers={},plugins.editors={},plugins.filters={},plugins.init=function(it){for(i=0;i<plugins.length;i++)new plugins[i];plugins.loaded=!0},plugins.event=function(type,args){args||(args=[]),type||(type=args.callee),"function"==typeof type&&(type=type.name),console.log(type,args)},plugins.filter=function(message){for(i in plugins.filters);return message},plugins.editor=function(type,object){if("function"==typeof type&&(type=type.name),plugins.editors[type])for(i=0;i<plugins.editors[type].length;i++)object=plugins.editors[type][i](object,type);return object},plugins.load=function(url,ready,error){return-1===name.indexOf(".js",name.length-3)&&(-1===name.indexOf(".plg",name.length-4)&&(url+=".plg"),url+=".js"),$.ajax({url:url,dataType:"script",success:ready,error:error,global:!1})},Plugin=function(func,proto){for(i in proto)this[i]=proto[i];func.prototype=this,plugins.push(func),plugins.loaded&&new func},Plugin.prototype={register:function(type,callback){this._register("handler",type,callback)},useEditor:function(type,callback){this._register("editor",type,callback)},useFilter:function(regex,callback){this._register("filter",regex,callback)},_register:function(type,f,c){return plugins[type+"s"][f]||plugins[type+"s"][f]=[],plugins[type+"s"][f].push($.proxy(c,this))}};var svp={};function hashRandom(str){if(0==str.length)return 0;var hash=Math.round(1e5*Math.random());for(i=0;i<str.length;i++)char=str.charCodeAt(i),hash=(hash<<5)-hash+char,hash&=hash;return Math.abs(hash)}function randomColor(){return"#"+("00000"+(0|Math.random()*(1<<24)).toString(16)).slice(-6)}function complementHex(hex_color){return c=hex_color.replace(/^#/,""),sum=parseInt(c[0]+c[1],16),sum+=parseInt(c[2]+c[3],16),sum+=parseInt(c[4]+c[5],16),200>sum?"#FFFFFF":"#000000"}function hhmmss(seconds,frac){return moment.unix(seconds-68400).format("HH:mm:ss"+(frac?".S":""))}svp.loadUrls=function(query,process){jsonurl="url-json/"+($("#url-file").val()?$("#url-file").val():"urls"),-1===jsonurl.indexOf(".json",jsonurl.length-5)&&(jsonurl+=".json"),$.ajax({url:jsonurl,cache:!1,dataType:"json"}).done(function(data,status,xhr){process(data)}).fail(function(xhr,error){console.log("Typeahead XHR Error:",error)}),$.ajax({url:jsonurl.slice(0,-5)+".info.json",cache:!1,dataType:"json"}).done(function(data,status,xhr){svp.videoInfo=data}).fail(function(xhr,error){console.log("Typeahead XHR Error:",error)})};function updateVideoInfo(item){return svp.videoInfo?(obj=svp.videoInfo[item])?(info='<div class="info-item info-title text-success"><h4>'+(obj.title?obj.title:"No Title")+'</h4></div><div class="info-item info-description">'+(obj.desc?obj.desc:"No Description")+"</div>"+'<div class="info-item info-website pull-right"><a'+(obj.link?' href="'+obj.link+'" target="_blank"':"")+">"+(obj.link?obj.link:"No Website")+"</a></div>"+'<div class="info-item info-length text-info">'+(obj.length?hhmmss(obj.length):"Unknown")+"</div>",$("#video-info").html(info),plugins.event(null,arguments),item):($("#video-info").html("Sorry, no info found for this url."),item):item}$("#video-url").typeahead({source:svp.loadUrls,minLength:0,updater:updateVideoInfo}).on("keyup change",function(){updateVideoInfo($(this).val())}),$(function(){function syncVolume(e,ui){svp.player.volume=ui.value/100,plugins.event(arguments.callee,[svp.player.volume])}$("#volume").slider({orientation:"vertical",range:"min",value:100,slide:syncVolume,change:syncVolume}).hide().parent().hover(function(){$("#volume").show()},function(){$("#volume").hide()}).click(function(){el=$("#volume"),val=el.slider("value"),0!==val?(el.data("old-volume",val),el.slider("value",0)):(val=el.data("old-volume"),el.slider("value",val?val:100))});try{$("#timeline").data("bumped",!1)}catch(err){}function syncPos(e){for(svp.watchers[0].pos=Math.round(10*svp.player.currentTime)/10,$(".watcher:first-of-type .time").text(hhmmss(svp.watchers[0].pos,!0)),$("#global-pos").css("width",100*(svp.player.currentTime/svp.player.duration)+"%"),texts=[hhmmss(svp.player.currentTime),"-"+hhmmss(svp.player.duration-svp.player.currentTime)],$(".span1.time").each(function(index,el){$(el).text(texts[index])}),time=svp.player.currentTime,origmin=min=$("#timeline").slider("option","min"),origmax=max=$("#timeline").slider("option","max"),$("#slider-view").css("width",100*((max-min)/svp.player.duration)+"%").css("left",100*(min/svp.player.duration)+"%"),chgsize=max-min-10;time+3>max;)$("#timeline").slider("option",{min:min+chgsize,max:max+chgsize}),min+=chgsize,max+=chgsize;for(;min>time-3;)$("#timeline").slider("option",{min:min-chgsize,max:max-chgsize}),min-=chgsize,max-=chgsize;0>min&&$("#timeline").slider("option",{min:0,max:max-min}),max>svp.player.duration&&$("#timeline").slider("option",{min:svp.player.duration-(max-min),max:svp.player.duration}),($("#timeline").slider("option","min")!==origmin||$("#timeline").slider("option","max")!==origmax)&&$("#timeline").data("bumped",!0),svp.ws.broadcast({type:"timeupdate",pos:svp.watchers[0].pos,id:svp.video.id}),syncAllPos(),plugins.event(null,arguments)}function syncAllPos(){pos=[];for(i in svp.watchers)"length"!==i&&(pos.push(svp.watchers[i].pos),$($(".watcher").get(i)).children(".time").text(hhmmss(svp.watchers[i].pos,!0)));$("#timeline").slider("option","values",pos)}function doubleRate(el){Math.abs(svp.player.playbackRate)<8?(svp.player.playbackRate*=2,$(el).html("&times;"+Math.abs(svp.player.playbackRate)),$(".playpause i").addClass("icon-play"),$(".playpause i").removeClass("icon-pause")):(svp.player.playbackRate=1,$(el).html($(el).data("original-html")),$(".playpause i").removeClass("icon-play"),$(".playpause i").addClass("icon-pause"))}svp.reverseSeeking=!1;function reverseSeek(){return svp.player.playbackRate>0?(svp.reverseSeeking=!1,!1):(svp.reverseSeeking=!0,svp.player.currentTime+=svp.player.playbackRate/2-.5,setTimeout(reverseSeek,500),void 0)}function resetTransport(){$("#fast-forward").html($("#fast-forward").data("original-html")),$("#fast-back").html($("#fast-back").data("original-html"))}$("#transport .btn[id]").click(function transportClick(e){resetTransport(),resetSync(),this.id.indexOf("fast")>=0?(svp.player.play(),$(this).data("original-html")||$(this).data("original-html",$(this).html()),this.id.indexOf("forward")>=0?(svp.player.playbackRate<0&&(svp.player.playbackRate=1),doubleRate(this)):(svp.player.playbackRate>0&&(svp.player.playbackRate=-1),doubleRate(this),reverseSeek())):this.id.indexOf("jump")>=0&&(svp.player.playbackRate=1,svp.player.currentTime+=this.id.indexOf("back")>=0?-300:300,broadcastJump()),plugins.event(null,arguments)});function broadcastJump(from){svp.ws.broadcast({id:svp.video.id,type:"jump",pos:svp.player.currentTime,from:from}),plugins.event(null,arguments)}function broadcastStateChange(){svp.ws.broadcast({id:svp.video.id,type:"statechange",paused:svp.player.paused}),plugins.event(null,arguments)}svp.tlsize=100;function rebuildTimeline(){min=max=null,tlsize=svp.tlsize;try{min=svp.player.currentTime-10,max=svp.player.currentTime+(tlsize-10)}catch(err){}try{min=$("#timeline").slider("option","min"),max=$("#timeline").slider("option","max")}catch(err){}max-min!==tlsize&&(max=min+tlsize);try{$("#timeline").slider("destroy")}catch(err){}values=[];for(i in svp.watchers)"length"!==i&&values.push(svp.watchers[i].pos);$("#timeline").slider({animate:!0,min:min?min:-10,max:max?max:tlsize-10,range:"min",step:.1,values:values,slide:function(e,ui){if(!$("#timeline").data("bumped")&&$(ui.handle).is(":first-of-type")){if($(ui.handle).next("div").remove(),resetSync(),ui.value<0)return e.preventDefault(),!1;svp.player.currentTime=ui.value,plugins.event("timelineSlide",[ui.value])}else e.preventDefault()},stop:function(e,ui){$("#timeline").data("bumped",!1),broadcastJump()},start:function(e,ui){$("#timeline").data("bumped",!1)}}).hover(function(){$("#timeline a:not(:first-of-type)").css("zIndex",1)},function(){$("#timeline a:not(:first-of-type)").css("zIndex",2)}),$("#timeline").children("a").each(function(index,el){node=$(el).attr("title",svp.watchers[index].name).attr("data-toggle","tooltip").tooltip().css("background-color",svp.watchers[index].color).css("background-image","none").css("opacity",svp.watchers[index].hidden?.2:1)}),$("#watchers h4 .badge-info").text(svp.watchers.length)}svp.rebuildTimeline=rebuildTimeline;function resetSync(){$("button.sync.active").each(function(index,el){name=$(el).parent().parent().prev().prev().text(),svp.ws.message({id:svp.video.id,type:"sync",sync:!1},name),$(el).effect("highlight").btn("toggle")}),svp.video.syncTo=0,plugins.event(null,arguments)}function addWatcher(watcher){index=svp.watcherIndices[watcher.name]=svp.watchers.push(watcher)-1,colorstyles=watcher.color?' style="background-color:'+watcher.color+";"+"color:"+complementHex(watcher.color.substr(1))+'"':"",$('<li class="watcher you row-fluid"'+colorstyles+">"+'<div class="span4 name">'+watcher.name+"</div>"+'<div class="span4 time">Loading...</div>'+'<div class="span4 actions"><div class="btn-group pull-right">'+'<button class="btn sync">'+("You"==watcher.name?"De-sync":"Sync")+"</button>"+'<button class="btn dropdown-toggle" data-toggle="dropdown">'+'<span class="caret"></span></button><ul class="dropdown-menu">'+'<li><a href="#" class="watcher-hide">Darken</a></li>'+"</ul></div></div></li>").appendTo("#watchers"),$("a.watcher-hide").eq(index).click(function(e){e.preventDefault(),index=$(this).data("watcher-index"),$(this).parent().toggleClass("active"),$(".watcher").eq(index).toggleClass("hidden-watcher"),svp.watchers[index].hidden=!svp.watchers[index].hidden,svp.rebuildTimeline()}).data("watcher-index",index),$("button.sync").eq(index).btn().click(function(e){return resetSync(),$(this).btn("toggle"),index=$(this).data("watcher-index"),svp.video.syncTo=index,0===index?($(this).btn("toggle"),!1):(svp.player.currentTime=svp.watchers[index].pos,svp.ws.message({id:svp.video.id,type:"sync",sync:!0},svp.watchers[index].name),void 0)}).data("watcher-index",index),rebuildTimeline(),plugins.event(null,arguments)}svp.addWatcher=addWatcher;function loadVideo(url,id){if(video={},video.url=url,video.id=id?id:hashRandom(video.url).toString(36),video.chats=[],"0"==video.id)return!1;try{$(".container-fluid.hide").removeClass("hide").show(),$("#volume").show().position({my:"center bottom",at:"center",of:$("#volume").prev()}).hide()}catch(err){}return svp.video=video,svp.watchers=[],svp.watcherIndices={},$("#link").val(location.origin+"/#join:"+svp.video.id),$(".watcher").remove(),$("#player").attr("src",plugins.editor("videoUrl",svp.video.url)),svp.player.load(),$("#current-url a").attr("href",svp.video.url).text(svp.video.url).click(function(e){e.preventDefault()}),svp.addWatcher({name:"You",pos:0,color:null}),plugins.event(null,arguments),!0}svp.loadVideo=loadVideo,$("#load-video-modal .modal-footer .btn-info").click(function(e){svp.loadVideo($("#video-url").val())?location.assign("#"):e.preventDefault()}),blackbg="body, .well, .progress, #chat-frame, #chat-entry, #current-url a",svp.resetPlayState=function resetPlayState(){$(".playpause i").removeClass("icon-pause"),$(".playpause i").addClass("icon-play"),$("#info .progress-default").removeClass("progress-striped active")},svp.lightsOn=function lightsOn(){$(blackbg).removeClass("blackbg muted",1e3).removeClass("blackbg muted"),$(".btn").removeClass("btn-inverse",500),$(".btn i").delay(300).removeClass("icon-white",1),$("#lights-text").text("Out"),svp.lightsAreOn=!0,plugins.event(null,arguments)},svp.lightsOff=function lightsOff(){$(blackbg).stop(!0,!0).addClass("blackbg muted"),$(".btn").stop(!0,!0).addClass("btn-inverse"),$(".btn i").stop(!0,!0).addClass("icon-white"),$("#lights-text").text("On"),svp.lightsAreOn=!1,plugins.event(null,arguments)},svp.lightsAreOn=!0;function stateChange(from){return resetTransport(),from||resetSync(),1!==svp.player.playbackRate?(svp.player.playbackRate=1,$(".playpause i").toggleClass("icon-pause icon-play"),broadcastJump(),!1):(svp.resetPlayState(),0===svp.player.readyState&&(svp.player.load(),console.log("Loading...")),svp.player.paused?(svp.lightsOff(),svp.player.play(),$("#info .progress-default").addClass("progress-striped active"),$(".playpause i").toggleClass("icon-pause icon-play")):svp.player.pause(),broadcastStateChange(from),plugins.event(null,arguments),void 0)}$(".playpause, #player").click(function playPause(e){stateChange(),plugins.event(null,arguments)}),$("#lights-control").click(function(){(svp.lightsAreOn?svp.lightsOff:svp.lightsOn)()}),svp.player=$("#player").get(0),svp.player.addEventListener("timeupdate",syncPos),svp.player.addEventListener("ended",svp.resetPlayState);function receiveChat(from,message,time){return message?(message=plugins.filter(message,from,time),colorstyle="background-color:"+svp.watchers[svp.watcherIndices[from]].color,timestamp=time?time:(new Date).getTime()/1e3,svp.video.chats.push({from:from,message:message,time:timestamp}),$("#chat-messages").append('<div class="media"><a class="pull-left chat-icon" style="'+colorstyle+'"></a>'+'<div class="media-body">'+'<div class="pull-right chat-time text-info" data-livestamp="'+timestamp+'"></div>'+'<h5 class="media-heading">'+from+"</h5>"+'<div class="chat-message">'+message+"</div>"+"</div></div>"),$("#chat-messages").scrollTop($("#chat-messages").prop("scrollHeight")),plugins.event(null,arguments),void 0):!1}$("#chat-input").keyup(function(e){13==e.which&&(svp.ws.broadcast({type:"chat",id:svp.video.id,message:$("#chat-input").val()}),receiveChat("You",$("#chat-input").val()),$("#chat-input").val(""))}),svp.ws=WSChat(),svp.ws.onerror=function wsError(code,message){console.log(code,message),305==code&&(location.assign("#error:nameexists"),location.reload()),plugins.event(null,arguments)},svp.ws.onmessage=function wsMessage(data,from,e){if("plugin"==data.type)plugins.event("plugin"+data.data.type,data.data);else if("info"==data.type){if(processChats=!1,svp.video&&svp.video.url===data.url||(svp.player.addEventListener("canplay",function(){console.log("Canplay"),svp.player.currentTime=data.mypos}),svp.loadVideo(data.url,svp.joinid),data.paused!==svp.player.paused&&stateChange(),processChats=!0),name in svp.watcherIndices||addWatcher({name:from,pos:data.mypos,color:randomColor()}),processChats)for(i in data.chats)if("length"!==i){chatfrom=data.chats[i].from,"You"==chatfrom&&(chatfrom=from),chatfrom==sessionStorage.svpUsername&&(chatfrom="You");
try{receiveChat(chatfrom,data.chats[i].message,data.chats[i].time)}catch(err){}}}else"sync"==data.type&&(console.log(from),$(".watcher").eq(svp.watcherIndices[from]).effect("highlight").attr("title",data.sync?"Synced to you":"No longer synced to you"));plugins.event(null,arguments)},svp.ws.onbroadcast=function wsBroadcast(data,from,e){if("pluginGlobal"==data.type&&plugins.event("pluginGlobal"+data.data.type,data.data),data.id!=(svp.video&&svp.video.id?svp.video.id:svp.joinid))return!1;if("plugin"==data.type)plugins.event("pluginBroadcast"+data.data.type,data.data);else if("join"==data.type)svp.ws.message({type:"info",url:svp.video.url,id:svp.video.id,chats:svp.video.chats,paused:svp.player.paused,mypos:svp.watchers[0].pos},from),from in svp.watcherIndices||svp.addWatcher({name:from,pos:0,color:randomColor()});else if("timeupdate"==data.type)try{svp.watchers[svp.watcherIndices[from]].pos=data.pos,syncAllPos()}catch(err){}else if("jump"==data.type)try{svp.watcherIndices[from]===svp.video.syncTo&&(data.from&&svp.watcherIndices[data.from]===svp.video.syncTo||(svp.player.currentTime=data.pos,broadcastJump(from)))}catch(err){}else if("statechange"==data.type)try{svp.watcherIndices[from]===svp.video.syncTo&&data.paused!==svp.player.paused&&stateChange(from)}catch(err){}else"chat"==data.type&&receiveChat(from,data.message);plugins.event(null,arguments)},svp.ws.onquit=function wsQuit(who,e){try{index=svp.watcherIndices[who]}catch(err){return!1}if(!index)return!1;console.log(index,svp.watchers[index],who),index===svp.video.syncTo?resetSync():index<svp.video.syncTo&&(svp.video.syncTo-=1),svp.watchers.splice(index,1);for(i in svp.watcherIndices)svp.watcherIndices[i]>index&&(svp.watcherIndices[i]-=1);delete svp.watcherIndices[who],$(".watcher").eq(index).remove(),rebuildTimeline(),plugins.event(null,arguments)};function watcherExists(name){for(i in svp.watchers)if("length"!==i&&svp.watchers[i].name==name)return!0}function init(name){localStorage.svpUsername=name,$("#load-video-modal").modal("show"),"join:"==location.hash.substr(1,5)&&($("#load-video-modal").modal("hide"),svp.ws.onconnected=function(e){svp.joinid=location.hash.substr(6),svp.ws.broadcast({type:"join",id:svp.joinid})}),svp.ws.init("ws://"+location.host+"/wschat",name),plugins.event(null,arguments)}svp.initializeClient=init,$("#set-name-modal").modal({backdrop:"static",keyboard:!1,show:!0}).modal("show"),"error:name"==location.hash.substr(1,10)?($("#nickname").val(localStorage.svpUsername),textel=$("#set-name-modal .alert-error").removeClass("hide").children("span"),error=location.hash.substr(7),"nameexists"==error?textel.html("Someone with that username is already connected to the server!<br>Please use a different username."):textel.html("A Username error occured! Please try again.")):localStorage.svpUsername&&($("#set-name-modal").modal("hide"),init(localStorage.svpUsername)),$("#set-name-modal .modal-footer .btn").click(function(){name=$("#nickname").val(),name&&($("#set-name-modal").modal("hide"),init(name))}),plugins.init(svp)});